<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Strict Focus App</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      text-align: center;
      transition: background 0.5s ease;
      user-select: none;
      touch-action: auto;
    }

    h1, h2, h3 {
      font-weight: 400;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
    }

    h1 {
      font-size: 3rem;
      margin: 32px 0;
    }

    h2 {
      font-size: 2.2rem;
      margin: 24px 0;
    }

    h3 {
      font-size: 1.8rem;
      margin: 16px 0;
    }

    label {
      font-size: 1.3rem;
      margin: 8px 0;
    }

    input, button, select, textarea {
      margin: 16px;
      padding: 18px 36px;
      font-size: 1.3rem;
      font-family: Arial, sans-serif;
      border: none;
      border-radius: 14px;
      transition: transform 0.2s, box-shadow 0.2s, background 0.3s;
      pointer-events: auto;
      min-width: 160px;
      touch-action: auto;
    }

    input[type="number"], input[type="text"], textarea {
      background: rgba(255, 255, 255, 0.12);
      color: #fff;
      text-align: center;
      width: 160px;
    }

    input[type="text"]#customWarning, textarea#allowedApps {
      width: 240px;
    }

    textarea#allowedApps {
      height: 80px;
      resize: none;
    }

    select {
      background: rgba(255, 255, 255, 0.12);
      color: #fff;
      width: 200px;
    }

    button {
      background: linear-gradient(45deg, #34d399, #2dd4bf);
      color: white;
      cursor: pointer;
      font-weight: 400;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
    }

    button:disabled {
      background: #4b5563;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    button.app-button {
      background: linear-gradient(45deg, #3b82f6, #60a5fa);
    }

    button.remove-button, #emergencyButton, button#startFocusButton {
      background: linear-gradient(45deg, #ef4444, #f87171);
      margin-left: 10px;
      padding: 10px 20px;
      font-size: 1rem;
    }

    button#viewHistoryButton {
      background: linear-gradient(45deg, #3b82f6, #60a5fa);
      margin-left: 10px;
      padding: 10px 20px;
      font-size: 1rem;
    }

    #lockScreen, #breakScreen, #historyScreen, #summary, #exitConfirmation {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #2a2a2a, #3a3a3a);
      color: white;
      z-index: 9999;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.5s ease-in;
      touch-action: none;
    }

    #overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 9998;
      pointer-events: "auto";
      touch-action: "auto";
    }

    #timer {
      font-size: 4.5rem;
      font-weight: 400;
      margin: 32px;
      text-shadow: 0 3px 8px rgba(0, 0, 0, 0.5);
      z-index: 10001;
      transition: transform 0.1s, opacity 0.1s;
    }

    @keyframes popInOut {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.6; }
      100% { transform: scale(1); opacity: 1; }
    }

    #warning {
      font-family: 'Engravers Gothic BT', 'Century Gothic', sans-serif;
      color: #f4f4f6;
      font-weight: 400;
      margin: 32px 0;
      font-size: 1.5rem;
      animation: slideIn 0.5s ease-out;
      max-width: 90%;
      text-align: center;
      z-index: 10000;
    }

    @keyframes slideIn {
      0% { transform: translateY(-20px); opacity: 0; }
      100% { transform: translateY(0); opacity: 1; }
    }

    #controls {
      display: flex;
      gap: 20px;
      z-index: 10000;
      flex-wrap: wrap;
      justify-content: center;
    }

    #breakScreen #controls {
      flex-direction: row;
    }

    #breakScreen #cancelButton {
      order: 1;
    }

    #breakScreen #continueButton {
      order: 2;
    }

    #exitConfirmation div {
      display: flex;
      gap: 20px;
      margin-top: 20px;
      flex-direction: row;
    }

    #exitConfirmation #cancelExitButton {
      order: 1;
    }

    #exitConfirmation #confirmExitButton {
      order: 2;
    }

    #summary, #historyScreen, #exitConfirmation {
      background: #2a2a2a;
      padding: 32px;
      border-radius: 18px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
      max-width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    #historyList {
      list-style: none;
      padding: 0;
      text-align: left;
      max-width: 100%;
    }

    #historyList li {
      margin: 16px 0;
      padding: 16px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 10px;
      font-size: 1.2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    @media (max-width: 600px) {
      h1 { font-size: 2.5rem; }
      h2 { font-size: 1.9rem; }
      h3 { font-size: 1.6rem; }
      #timer { font-size: 3.5rem; }
      label { font-size: 1.2rem; }
      input, button, select, textarea { 
        font-size: 1.1rem; 
        padding: 14px 28px; 
        min-width: 140px;
      }
      input[type="number"], input[type="text"], textarea { width: 140px; }
      input[type="text"]#customWarning, textarea#allowedApps { width: 200px; }
      textarea#allowedApps { height: 60px; }
      select { width: 180px; }
      #warning { font-size: 1.3rem; }
      #summary, #historyScreen, #exitConfirmation { font-size: 1.1rem; padding: 24px; }
      #historyList li { font-size: 1rem; }
      button.remove-button, #emergencyButton, button#startFocusButton, button#viewHistoryButton { padding: 8px 16px; font-size: 0.9rem; }
    }

    @media (max-width: 400px) {
      h1 { font-size: 2.1rem; }
      h2 { font-size: 1.6rem; }
      h3 { font-size: 1.4rem; }
      #timer { font-size: 3rem; }
      label { font-size: 1.1rem; }
      input, button, select, textarea { 
        font-size: 1rem; 
        padding: 12px 24px; 
        min-width: 120px;
      }
      input[type="number"], input[type="text"], textarea { width: 120px; }
      input[type="text"]#customWarning, textarea#allowedApps { width: 180px; }
      textarea#allowedApps { height: 50px; }
      select { width: 160px; }
      #warning { font-size: 1.2rem; }
      #summary, #historyScreen, #exitConfirmation { font-size: 1rem; padding: 20px; }
      #historyList li { font-size: 0.9rem; }
      button.remove-button, #emergencyButton, button#startFocusButton, button#viewHistoryButton { padding: 6px 12px; font-size: 0.8rem; }
    }
  </style>
</head>
<body>
  <h1>🔒 Strict Focus Mode</h1>
  <label for="minutes">Focus Duration (minutes):</label>
  <input type="number" id="minutes" value="25" min="1" max="180" />
  <label for="breakMinutes">Break Duration (minutes):</label>
  <input type="number" id="breakMinutes" value="5" min="1" max="60" />
  <label for="customWarning">Custom Warning Message:</label>
  <input type="text" id="customWarning" placeholder="Stay focused!" maxlength="100" />
  <label for="allowedApps">Allowed Apps (one URL per line, e.g., https://www.google.com/keep):</label>
  <textarea id="allowedApps" placeholder="Enter app URLs, one per line"></textarea>
  <label for="alarmSound">Alarm Sound:</label>
  <select id="alarmSound">
    <option value="default">Default Alarm</option>
    <option value="beep">Beep</option>
    <option value="chime">Chime</option>
    <option value="custom">Custom</option>
  </select>
  <input type="file" id="customAlarm" accept="audio/*" style="display: none;" />
  <div>
    <label><input type="checkbox" id="soundToggle" checked> Enable Sound</label>
  </div>
  <button id="startFocusButton" onclick="startFocus()">Start Focus</button>
  <button id="viewHistoryButton" onclick="showHistory()">View History</button>

  <div id="lockScreen">
    <div id="overlay"></div>
    <h2>🚫 Stay Focused!</h2>
    <div id="timer">--:--</div>
    <div id="warning"></div>
    <div id="controls"></div>
  </div>

  <div id="breakScreen">
    <div id="overlay"></div>
    <h2>☕ Break Time!</h2>
    <div id="timer">--:--</div>
    <div id="warning"></div>
    <div id="controls"></div>
  </div>

  <div id="exitConfirmation">
    <h3>Confirm Exit</h3>
    <p id="exitPrompt">Type the number shown below to end focus mode:</p>
    <p id="randomNumber"></p>
    <input type="text" id="exitInput" style="width: 160px;" />
    <div>
      <button id="cancelExitButton" onclick="cancelExit()">Cancel</button>
      <button id="confirmExitButton" onclick="confirmExit()">Confirm</button>
    </div>
  </div>

  <div id="summary">
    <h3>Focus Session Summary</h3>
    <p id="summaryText"></p>
    <button onclick="closeSummary()">Close</button>
  </div>

  <div id="historyScreen">
    <h3>Focus History</h3>
    <ul id="historyList"></ul>
    <button onclick="closeHistory()">Close</button>
  </div>

  <audio id="alarmDefault" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>
  <audio id="alarmBeep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>
  <audio id="alarmChime" src="https://actions.google.com/sounds/v1/alarms/chime.ogg" preload="auto"></audio>
  <audio id="alarmCustom"></audio>

  <script>
    let endTime, interval, totalDuration, isPaused = false, isFocusMode = false, pauseStartTime, interruptions = 0, startTime, mode = 'focus', focusRemaining = 0, allowedApps = [], exitCode = '', customAlarmFile = null;

    function startFocus() {
      const minutes = parseInt(document.getElementById("minutes").value);
      const breakMinutesInput = document.getElementById("breakMinutes").value;
      const breakMinutes = parseInt(breakMinutesInput) || 5;
      if (!minutes || minutes <= 0) {
        alert("Enter a valid focus duration");
        return;
      }

      // Load allowed apps
      const allowedAppsInput = document.getElementById("allowedApps").value.trim();
      allowedApps = allowedAppsInput ? allowedAppsInput.split('\n').map(url => url.trim()).filter(url => url) : [];
      localStorage.setItem("allowedApps", JSON.stringify(allowedApps));

      totalDuration = minutes * 60 * 1000;
      startTime = Date.now();
      endTime = startTime + totalDuration;
      isPaused = false;
      isFocusMode = true;
      mode = 'focus';
      interruptions = 0;
      document.getElementById("lockScreen").style.display = "flex";
      document.getElementById("breakScreen").style.display = "none";
      document.getElementById("warning").textContent = "";
      updateControls();
      document.getElementById("minutes").disabled = true;
      document.getElementById("breakMinutes").disabled = true;
      document.getElementById("customWarning").disabled = true;
      document.getElementById("allowedApps").disabled = true;
      document.getElementById("alarmSound").disabled = true;
      document.getElementById("customAlarm").disabled = true;
      document.getElementById("soundToggle").disabled = true;
      document.querySelector("#startFocusButton").disabled = true;
      document.querySelector("#viewHistoryButton").disabled = true;
      document.body.style.pointerEvents = "none";
      document.body.style.touchAction = "none";
      document.getElementById("lockScreen").style.pointerEvents = "none";
      document.getElementById("lockScreen").style.touchAction = "none";
      document.body.requestFullscreen().catch(() => console.log("Fullscreen request failed"));
      updateTimer();
      interval = setInterval(updateTimer, 1000);
      console.log("Focus mode started", { minutes, breakMinutes, totalDuration, endTime });
      if (navigator.vibrate) navigator.vibrate(100);
      lockOrientation();
    }

    function updateControls() {
      const controls = document.querySelector(`#${mode === 'focus' ? 'lockScreen' : 'breakScreen'} #controls`);
      controls.innerHTML = '';
      if (mode === 'focus') {
        controls.innerHTML += `
          <button id="pauseButton" onclick="pauseFocus()" style="display: ${isPaused ? 'none' : 'inline-block'}">Pause</button>
          <button id="continueButton" onclick="continueFocus()" style="display: ${isPaused ? 'inline-block' : 'none'}">Continue</button>
          <button id="breakButton" onclick="startBreak()" style="display: ${isPaused ? 'none' : 'inline-block'}">Take Break</button>
          <button id="emergencyButton" onclick="showExitConfirmation()">Emergency Exit</button>
        `;
      } else {
        controls.innerHTML += `
          <button id="cancelButton" onclick="cancelBreak()" style="display: ${isPaused ? 'inline-block' : 'none'}">Cancel</button>
          <button id="continueButton" onclick="endBreak()" style="display: ${isPaused ? 'none' : 'inline-block'}">Continue</button>
        `;
      }
      allowedApps.forEach((url, index) => {
        const button = document.createElement('button');
        button.className = 'app-button';
        button.textContent = `Open App ${index + 1}`;
        button.onclick = () => window.open(url, '_blank');
        button.style.pointerEvents = 'auto';
        button.style.touchAction = 'auto';
        controls.appendChild(button);
      });
      controls.querySelectorAll('button').forEach(btn => {
        btn.style.pointerEvents = 'auto';
        btn.style.touchAction = 'auto';
      });
    }

    function updateTimer() {
      if (isPaused) return;

      try {
        const now = Date.now();
        const remaining = endTime - now;

        if (remaining <= 0) {
          clearInterval(interval);
          document.getElementById("timer").textContent = mode === 'focus' ? "✅ Time's Up!" : "🏁 Break Over!";
          document.getElementById("timer").style.animation = "";
          playAlarm();
          if (mode === 'focus') {
            setTimeout(showSummary, 4000);
          } else {
            setTimeout(endBreak, 4000);
          }
          console.log(`Timer ended: ${mode}`);
          return;
        }

        const mins = Math.floor(remaining / 60000);
        const secs = Math.floor((remaining % 60000) / 1000);
        document.getElementById("timer").textContent = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        // Force animation reset for every second
        document.getElementById("timer").style.animation = "none";
        void document.getElementById("timer").offsetWidth; // Trigger reflow
        document.getElementById("timer").style.animation = "popInOut 1s ease-in-out";
        console.log(`Timer updated: ${mode}, remaining: ${remaining}ms, display: ${mins}:${secs}`);
      } catch (error) {
        console.error("Error in updateTimer:", error);
        document.getElementById("timer").textContent = "Error";
      }
    }

    function pauseFocus() {
      if (!isFocusMode || mode !== 'focus') return;
      isPaused = true;
      clearInterval(interval);
      pauseStartTime = Date.now();
      document.getElementById("warning").textContent = "⏸️ Focus Paused";
      document.getElementById("timer").style.animation = "";
      updateControls();
      console.log("Focus paused");
      if (navigator.vibrate) navigator.vibrate(100);
    }

    function continueFocus() {
      if (!isFocusMode || mode !== 'focus') return;
      isPaused = false;
      const pauseDuration = Date.now() - pauseStartTime;
      endTime += pauseDuration;
      document.getElementById("warning").textContent = "";
      updateControls();
      updateTimer();
      interval = setInterval(updateTimer, 1000);
      console.log("Focus resumed", { endTime });
      if (navigator.vibrate) navigator.vibrate(100);
    }

    function startBreak() {
      if (!isFocusMode || mode !== 'focus') return;
      isPaused = true;
      clearInterval(interval);
      focusRemaining = endTime - Date.now();
      const breakMinutesInput = document.getElementById("breakMinutes").value;
      const breakMinutes = parseInt(breakMinutesInput) || 5;
      if (isNaN(breakMinutes) || breakMinutes <= 0) {
        alert("Please enter a valid break duration");
        isPaused = false;
        interval = setInterval(updateTimer, 1000);
        return;
      }
      try {
        totalDuration = breakMinutes * 60 * 1000;
        startTime = Date.now();
        endTime = startTime + totalDuration;
        isPaused = false;
        mode = 'break';
        document.getElementById("lockScreen").style.display = "none";
        document.getElementById("breakScreen").style.display = "flex";
        document.getElementById("warning").textContent = "";
        updateControls();
        document.body.requestFullscreen().catch(() => console.log("Fullscreen request failed"));
        updateTimer();
        interval = setInterval(updateTimer, 1000);
        console.log("Break mode started", { breakMinutes, totalDuration, endTime, focusRemaining });
      } catch (error) {
        console.error("Error in startBreak:", error);
        alert("Failed to start break timer");
        isPaused = false;
        mode = 'focus';
        interval = setInterval(updateTimer, 1000);
      }
      if (navigator.vibrate) navigator.vibrate(100);
    }

    function cancelBreak() {
      if (!isFocusMode || mode !== 'break') return;
      isPaused = false;
      const pauseDuration = Date.now() - pauseStartTime;
      endTime += pauseDuration;
      document.getElementById("warning").textContent = "";
      updateControls();
      updateTimer();
      interval = setInterval(updateTimer, 1000);
      console.log("Break resumed", { endTime });
      if (navigator.vibrate) navigator.vibrate(100);
    }

    function endBreak() {
      try {
        clearInterval(interval);
        document.getElementById("breakScreen").style.display = "none";
        mode = 'focus';
        endTime = Date.now() + focusRemaining;
        isPaused = false;
        document.getElementById("lockScreen").style.display = "flex";
        document.getElementById("warning").textContent = "";
        updateControls();
        document.body.requestFullscreen().catch(() => console.log("Fullscreen request failed"));
        updateTimer();
        interval = setInterval(updateTimer, 1000);
        console.log("Break mode ended, focus resumed", { focusRemaining, endTime });
      } catch (error) {
        console.error("Error in endBreak:", error);
        alert("Failed to resume focus timer");
      }
      if (navigator.vibrate) navigator.vibrate(100);
    }

    function showExitConfirmation() {
      if (!isFocusMode) return;
      exitCode = Math.floor(Math.random() * 10).toString();
      document.getElementById("randomNumber").textContent = exitCode;
      document.getElementById("exitConfirmation").style.display = "block";
      document.getElementById("exitInput").value = "";
      document.getElementById("exitInput").style.pointerEvents = "auto";
      document.getElementById("exitInput").style.touchAction = "auto";
      document.getElementById("confirmExitButton").style.pointerEvents = "auto";
      document.getElementById("confirmExitButton").style.touchAction = "auto";
      document.getElementById("cancelExitButton").style.pointerEvents = "auto";
      document.getElementById("cancelExitButton").style.touchAction = "auto";
      console.log("Exit confirmation shown", { exitCode });
    }

    function confirmExit() {
      if (document.getElementById("exitInput").value === exitCode) {
        document.getElementById("exitConfirmation").style.display = "none";
        endFocus();
      } else {
        alert("Please type the correct number.");
      }
    }

    function cancelExit() {
      document.getElementById("exitConfirmation").style.display = "none";
    }

    function endFocus() {
      try {
        clearInterval(interval);
        document.exitFullscreen().catch(() => console.log("Exit fullscreen failed"));
        document.getElementById("lockScreen").style.display = "none";
        document.getElementById("breakScreen").style.display = "none";
        document.getElementById("minutes").disabled = false;
        document.getElementById("breakMinutes").disabled = false;
        document.getElementById("customWarning").disabled = false;
        document.getElementById("allowedApps").disabled = false;
        document.getElementById("alarmSound").disabled = false;
        document.getElementById("customAlarm").disabled = false;
        document.getElementById("soundToggle").disabled = false;
        document.querySelector("#startFocusButton").disabled = false;
        document.querySelector("#viewHistoryButton").disabled = false;
        document.body.style.pointerEvents = "auto";
        document.body.style.touchAction = "auto";
        document.getElementById("lockScreen").style.pointerEvents = "none";
        document.getElementById("lockScreen").style.touchAction = "none";
        document.getElementById("breakScreen").style.pointerEvents = "none";
        document.getElementById("breakScreen").style.touchAction = "none";
        isPaused = false;
        isFocusMode = false;
        mode = 'focus';
        document.getElementById("timer").textContent = "--:--";
        document.getElementById("timer").style.animation = "";
        updateControls();
        saveSession();
        showSummary();
        unlockOrientation();
        console.log("Focus mode ended");
      } catch (error) {
        console.error("Error in endFocus:", error);
      }
    }

    function handleUnauthorizedInteraction(e) {
      if (!isFocusMode || isPaused) return;
      if (e.target.classList.contains('app-button')) return;
      isPaused = true;
      interruptions++;
      clearInterval(interval);
      pauseStartTime = Date.now();
      const customMsg = document.getElementById("customWarning").value.trim() || "Stay focused!";
      document.getElementById("warning").textContent = `⚠️ Unauthorized interaction detected! ${customMsg} Press Cancel to resume.`;
      document.getElementById("timer").style.animation = "";
      updateControls();
      console.log("Unauthorized interaction detected");
      if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
    }

    function playAlarm() {
      if (!document.getElementById("soundToggle").checked) return;
      try {
        const sound = document.getElementById("alarmSound").value;
        if (sound === 'custom' && customAlarmFile) {
          const audio = document.getElementById("alarmCustom");
          audio.src = URL.createObjectURL(customAlarmFile);
          audio.play().catch(() => console.log("Custom audio playback failed"));
        } else {
          const audio = document.getElementById(`alarm${sound.charAt(0).toUpperCase() + sound.slice(1)}`);
          audio.play().catch(() => console.log("Audio playback failed"));
        }
      } catch (error) {
        console.error("Error in playAlarm:", error);
      }
    }

    function saveSession() {
      try {
        const totalTime = (Date.now() - startTime) / 60000;
        const session = {
          date: new Date().toLocaleString(),
          duration: totalTime.toFixed(1),
          interruptions: interruptions,
        };
        let sessions = JSON.parse(localStorage.getItem("focusSessions") || "[]");
        sessions.push(session);
        localStorage.setItem("focusSessions", JSON.stringify(sessions));
      } catch (error) {
        console.error("Error in saveSession:", error);
      }
    }

    function showSummary() {
      try {
        const totalTime = (Date.now() - startTime) / 60000;
        const summaryText = `Session Duration: ${totalTime.toFixed(1)} minutes\nInterruptions: ${interruptions}`;
        document.getElementById("summaryText").textContent = summaryText;
        document.getElementById("summary").style.display = "block";
        document.querySelector("#summary button[onclick='closeSummary()']").style.pointerEvents = "auto";
        document.querySelector("#summary button[onclick='closeSummary()']").style.touchAction = "auto";
      } catch (error) {
        console.error("Error in showSummary:", error);
      }
    }

    function closeSummary() {
      document.getElementById("summary").style.display = "none";
    }

    function showHistory() {
      try {
        const sessions = JSON.parse(localStorage.getItem("focusSessions") || "[]");
        const historyList = document.getElementById("historyList");
        historyList.innerHTML = "";
        sessions.forEach((session, index) => {
          const li = document.createElement("li");
          li.innerHTML = `Date: ${session.date}, Duration: ${session.duration} min, Interruptions: ${session.interruptions}
            <button class="remove-button" onclick="removeHistoryEntry(${index})">Remove</button>`;
          historyList.appendChild(li);
        });
        document.getElementById("historyScreen").style.display = "flex";
        document.querySelector("#historyScreen button[onclick='closeHistory()']").style.pointerEvents = "auto";
        document.querySelector("#historyScreen button[onclick='closeHistory()']").style.touchAction = "auto";
        historyList.querySelectorAll(".remove-button").forEach(btn => {
          btn.style.pointerEvents = 'auto';
          btn.style.touchAction = 'auto';
        });
      } catch (error) {
        console.error("Error in showHistory:", error);
      }
    }

    function removeHistoryEntry(index) {
      try {
        let sessions = JSON.parse(localStorage.getItem("focusSessions") || "[]");
        sessions.splice(index, 1);
        localStorage.setItem("focusSessions", JSON.stringify(sessions));
        showHistory();
        console.log(`Removed history entry at index ${index}`);
      } catch (error) {
        console.error("Error in removeHistoryEntry:", error);
      }
    }

    function closeHistory() {
      document.getElementById("historyScreen").style.display = "none";
    }

    function lockOrientation() {
      if (screen.orientation && screen.orientation.lock) {
        screen.orientation.lock("portrait").catch(() => console.log("Orientation lock failed"));
      }
    }

    function unlockOrientation() {
      if (screen.orientation && screen.orientation.unlock) {
        screen.orientation.unlock();
      }
    }

    // Handle custom alarm file selection
    document.getElementById("alarmSound").addEventListener("change", () => {
      if (document.getElementById("alarmSound").value === 'custom') {
        document.getElementById("customAlarm").click();
      }
    });

    document.getElementById("customAlarm").addEventListener("change", (e) => {
      if (e.target.files.length > 0) {
        customAlarmFile = e.target.files[0];
        console.log("Custom alarm file selected", { fileName: customAlarmFile.name });
      }
    });

    // Block all keyboard interactions
    document.addEventListener("keydown", (e) => {
      if (isFocusMode && e.target.id !== "emergencyButton" && e.target.id !== "pauseButton" && e.target.id !== "continueButton" && e.target.id !== "breakButton" && e.target.id !== "cancelButton" && e.target.id !== "exitInput" && !e.target.closest("#exitConfirmation")) {
        e.preventDefault();
        handleUnauthorizedInteraction(e);
      }
    });

    // Block all mouse clicks except on allowed elements
    document.addEventListener("click", (e) => {
      if (isFocusMode && e.target.id !== "emergencyButton" && e.target.id !== "pauseButton" && e.target.id !== "continueButton" && e.target.id !== "breakButton" && e.target.id !== "cancelButton" && e.target.id !== "confirmExitButton" && e.target.id !== "cancelExitButton" && !e.target.closest("#exitConfirmation") && !e.target.closest("#summary") && !e.target.closest("#historyScreen") && !e.target.classList.contains('app-button')) {
        e.preventDefault();
        handleUnauthorizedInteraction(e);
      }
    });

    // Block all touch interactions except on allowed elements
    document.addEventListener("touchstart", (e) => {
      if (isFocusMode && e.target.id !== "emergencyButton" && e.target.id !== "pauseButton" && e.target.id !== "continueButton" && e.target.id !== "breakButton" && e.target.id !== "cancelButton" && e.target.id !== "confirmExitButton" && e.target.id !== "cancelExitButton" && !e.target.closest("#exitConfirmation") && !e.target.closest("#summary") && !e.target.closest("#historyScreen") && !e.target.classList.contains('app-button')) {
        e.preventDefault();
        handleUnauthorizedInteraction(e);
      }
    });

    // Detect tab switching
    document.addEventListener("visibilitychange", () => {
      if (isFocusMode && document.hidden) {
        handleUnauthorizedInteraction({});
      }
    });

    // Prevent new tab/window shortcuts
    document.addEventListener("keydown", (e) => {
      if (isFocusMode) {
        if ((e.ctrlKey && (e.key === 't' || e.key === 'T' || e.key === 'n' || e.key === 'N')) ||
            (e.metaKey && (e.key === 't' || e.key === 'T' || e.key === 'N'))) {
          e.preventDefault();
          handleUnauthorizedInteraction(e);
        }
      }
    });

    window.onload = () => {
      try {
        const lastDuration = localStorage.getItem("lastDuration");
        const lastBreakDuration = localStorage.getItem("lastBreakDuration");
        const savedAllowedApps = localStorage.getItem("allowedApps");
        if (lastDuration) document.getElementById("minutes").value = lastDuration;
        if (lastBreakDuration) document.getElementById("breakMinutes").value = lastBreakDuration;
        if (savedAllowedApps) document.getElementById("allowedApps").value = JSON.parse(savedAllowedApps).join('\n');
        document.body.style.touchAction = "auto";
        console.log("Page loaded");
      } catch (error) {
        console.error("Error on page load:", error);
      }
    };
  </script>
</body>
</html>
